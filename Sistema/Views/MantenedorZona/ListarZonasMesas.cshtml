@{
    ViewData["Title"] = "Gestión de Zonas y Mesas";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2 class="mb-3">Gestión de Zonas y Mesas</h2>

<div class="row">
    <!-- Panel de zonas -->
    <div class="col-md-3">
        <div class="card mb-3">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span>Zonas</span>
                <button class="btn btn-light btn-sm" id="btnAgregarZona">
                    <i class="bi bi-plus"></i>
                </button>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush" id="listaZonas">
                    <!-- Se cargarán dinámicamente -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Panel del croquis de mesas -->
    <div class="col-md-9">
        <div class="card">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <span id="tituloZona">Seleccione una zona</span>
                <button class="btn btn-light btn-sm" id="btnAgregarMesa" disabled>
                    <i class="bi bi-plus-circle"></i> Agregar Mesa
                </button>
            </div>
            <div class="card-body">
                <div id="zonaCroquis" style="position: relative; min-height: 500px; border: 2px dashed #ccc; border-radius: 8px; background-color: #f8f9fa;">
                    <p class="text-muted text-center" style="padding-top: 200px;" id="mensajeInicial">
                        <i class="bi bi-hand-index" style="font-size: 3rem;"></i><br>
                        Selecciona una zona para ver las mesas
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

@await Html.PartialAsync("_ModalZona")
@await Html.PartialAsync("_ModalMesa")

@section Scripts {
    <link href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" rel="stylesheet" />
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <style>
        .zona-item {
            cursor: pointer;
            transition: all 0.2s;
        }

            .zona-item:hover {
                background-color: #f0f0f0;
            }

            .zona-item.active {
                background-color: #0d6efd;
                color: white !important;
            }

                .zona-item.active .badge {
                    background-color: white !important;
                    color: #0d6efd !important;
                }

        .mesa-item {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: move;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.25);
            transition: transform 0.2s, box-shadow 0.2s;
            user-select: none;
            border: 3px solid rgba(255,255,255,0.3);
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

            .mesa-item:hover {
                transform: scale(1.1);
                z-index: 100;
            }

        .mesa-disponible {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .mesa-ocupada {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
        }

        .mesa-reservada {
            background: linear-gradient(135deg, #ffc107 0%, #ffca2c 100%);
            color: white;
        }

        .mesa-limpieza {
            background: linear-gradient(135deg, #6c757d 0%, #adb5bd 100%);
            color: white;
        }

        .ui-draggable-dragging {
            opacity: 0.7;
            z-index: 1000;
        }

        .btn-eliminar-mesa {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            padding: 0;
            font-size: 12px;
            line-height: 1;
            display: none;
        }

        .mesa-item:hover .btn-eliminar-mesa {
            display: block;
        }
    </style>

    <script>
        let zonaSeleccionada = null;
        let zonaSeleccionadaNombre = "";

        $(document).ready(function () {
            cargarZonas();

            // ========================================
            // CARGAR ZONAS
            // ========================================
            function cargarZonas() {
                $.get('@Url.Action("ObtenerZonas", "MantenedorZona")', function (res) {
                    let lista = $("#listaZonas").empty();
                    if (res.data && res.data.length > 0) {
                        res.data.forEach(z => {
                            let badgeClass = z.estado ? "bg-success" : "bg-secondary";
                            let badgeText = z.estado ? "Activo" : "Inactivo";

                            lista.append(`
                                <li class="list-group-item zona-item d-flex justify-content-between align-items-center"
                                    data-id="${z.zonaId}"
                                    data-nombre="${z.nombre}">
                                    <span>${z.nombre}</span>
                                    <span class="badge ${badgeClass}">${badgeText}</span>
                                </li>
                            `);
                        });
                    } else {
                        lista.append('<li class="list-group-item text-muted">No hay zonas registradas</li>');
                    }
                });
            }

            // ========================================
            // SELECCIONAR ZONA
            // ========================================
            $(document).on("click", ".zona-item", function () {
                zonaSeleccionada = $(this).data("id");
                zonaSeleccionadaNombre = $(this).data("nombre");

                $(".zona-item").removeClass("active");
                $(this).addClass("active");

                $("#tituloZona").text("Zona: " + zonaSeleccionadaNombre);
                $("#btnAgregarMesa").prop("disabled", false);

                cargarMesasPorZona(zonaSeleccionada);
            });

            // ========================================
            // CARGAR MESAS POR ZONA
            // ========================================
            function cargarMesasPorZona(zonaId) {
                $.get('@Url.Action("ListarMesasPorZona", "MantenedorMesa")', { zonaId: zonaId }, function (res) {
                    let contenedor = $("#zonaCroquis");
                    contenedor.empty();
                    $("#mensajeInicial").hide();

                    if (res.data && res.data.length > 0) {
                        res.data.forEach(m => {
                            let claseEstado = obtenerClaseEstado(m.estado);
                            let mesaHtml = `
                                <div class="mesa-item ${claseEstado}"
                                     data-id="${m.mesaId}"
                                     data-nro="${m.nroMesa}"
                                     data-estado="${m.estado}"
                                     style="left: ${m.posicionX}px; top: ${m.posicionY}px;">
                                    Mesa ${m.nroMesa}
                                    <button class="btn btn-danger btn-sm btn-eliminar-mesa"
                                            data-id="${m.mesaId}"
                                            title="Eliminar">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            `;
                            contenedor.append(mesaHtml);
                        });

                        // Hacer mesas arrastrables
                        $(".mesa-item").draggable({
                            containment: "#zonaCroquis",
                            stop: function(event, ui) {
                                let mesaId = $(this).data("id");
                                let posX = ui.position.left;
                                let posY = ui.position.top;

                                actualizarPosicionMesa(mesaId, posX, posY);
                            }
                        });

                        // Doble click para editar
                        $(".mesa-item").dblclick(function() {
                            let mesaId = $(this).data("id");
                            let nroMesa = $(this).data("nro");
                            let estado = $(this).data("estado");

                            abrirModalEditarMesa(mesaId, nroMesa, estado);
                        });

                    } else {
                        contenedor.html(`
                            <p class="text-muted text-center" style="padding-top: 200px;">
                                <i class="bi bi-inbox" style="font-size: 3rem;"></i><br>
                                No hay mesas en esta zona<br>
                                <button class="btn btn-success mt-3" id="btnAgregarMesaRapido">
                                    <i class="bi bi-plus-circle"></i> Agregar Primera Mesa
                                </button>
                            </p>
                        `);
                    }
                });
            }

            // Agregar mesa rápido desde mensaje vacío
            $(document).on("click", "#btnAgregarMesaRapido", function() {
                $("#btnAgregarMesa").click();
            });

            // ========================================
            // OBTENER CLASE SEGÚN ESTADO
            // ========================================
            function obtenerClaseEstado(estado) {
                switch(estado.toLowerCase()) {
                    case 'disponible': return 'mesa-disponible';
                    case 'ocupada': return 'mesa-ocupada';
                    case 'reservada': return 'mesa-reservada';
                    case 'limpieza': return 'mesa-limpieza';
                    default: return 'mesa-disponible';
                }
            }

            function actualizarPosicionMesa(mesaId, posX, posY) {
                // Redondear las posiciones
                posX = Math.round(posX);
                posY = Math.round(posY);

                console.log('Actualizando mesa:', mesaId, 'X:', posX, 'Y:', posY); // Debug

                $.ajax({
                    url: '@Url.Action("ActualizarPosicion", "MantenedorMesa")',
                    type: "POST",
                    data: {
                        mesaId: mesaId,
                        posicionX: posX,
                        posicionY: posY
                    },
                    success: function(res) {
                        console.log('Respuesta del servidor:', res); // Debug
                        if (res.resultado) {
                            console.log('✓ Posición actualizada correctamente');
                        } else {
                            alert("Error al actualizar posición: " + res.mensaje);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error AJAX:', status, error); // Debug
                        alert("Error de comunicación: " + error);
                    }
                });
            }

            // ========================================
            // AGREGAR ZONA
            // ========================================
            $("#btnAgregarZona").click(function () {
                $("#modalZonaLabel").text("Agregar Zona");
                $("#formZona")[0].reset();
                $("#zonaId").val("");
                $("#estadoZona").val("true");
                $("#modalZona").modal("show");
            });

            $("#formZona").submit(function(e) {
                e.preventDefault();

                let datos = {
                    zonaId: parseInt($("#zonaId").val()) || 0,
                    nombre: $("#nombreZona").val().trim(),
                    estado: $("#estadoZona").val() === "true"
                };

                if (!datos.nombre) {
                    alert("Ingrese el nombre de la zona");
                    return;
                }

                $.ajax({
                    url: '@Url.Action("GuardarZona", "MantenedorZona")',
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(datos),
                    success: function(res) {
                        if (res.resultado) {
                            alert(res.mensaje);
                            $("#modalZona").modal("hide");
                            cargarZonas();
                        } else {
                            alert(res.mensaje);
                        }
                    }
                });
            });

            // ========================================
            // AGREGAR MESA
            // ========================================
            $("#btnAgregarMesa").click(function () {
                if (!zonaSeleccionada) {
                    alert("Primero selecciona una zona");
                    return;
                }

                $("#modalMesaLabel").text("Agregar Mesa");
                $("#formMesa")[0].reset();
                $("#mesaId").val("");
                $("#zonaIdMesa").val(zonaSeleccionada);
                $("#estadoMesa").val("Disponible");
                $("#modalMesa").modal("show");
            });

            function abrirModalEditarMesa(mesaId, nroMesa, estado) {
                $("#modalMesaLabel").text("Editar Mesa");
                $("#mesaId").val(mesaId);
                $("#nombreMesa").val(nroMesa);
                $("#estadoMesa").val(estado);
                $("#zonaIdMesa").val(zonaSeleccionada);
                $("#modalMesa").modal("show");
            }

            $("#formMesa").submit(function(e) {
                e.preventDefault();

                let mesaId = parseInt($("#mesaId").val()) || 0;
                let posX = mesaId === 0 ? 50 : 0; // Posición inicial si es nueva
                let posY = mesaId === 0 ? 50 : 0;

                let datos = {
                    mesaId: mesaId,
                    nroMesa: parseInt($("#nombreMesa").val()),
                    zonaId: parseInt($("#zonaIdMesa").val()),
                    estado: $("#estadoMesa").val(),
                    posicionX: posX,
                    posicionY: posY
                };

                if (!datos.nroMesa) {
                    alert("Ingrese el número de mesa");
                    return;
                }

                $.ajax({
                    url: '@Url.Action("GuardarMesa", "MantenedorMesa")',
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(datos),
                    success: function(res) {
                        if (res.resultado) {
                            alert(res.mensaje);
                            $("#modalMesa").modal("hide");
                            cargarMesasPorZona(zonaSeleccionada);
                        } else {
                            alert(res.mensaje);
                        }
                    }
                });
            });

            // ========================================
            // ELIMINAR MESA
            // ========================================
            $(document).on("click", ".btn-eliminar-mesa", function(e) {
                e.stopPropagation();

                let mesaId = $(this).data("id");

                if (confirm("¿Está seguro de eliminar esta mesa?")) {
                    $.post('@Url.Action("EliminarMesa", "MantenedorMesa")',
                        { mesaId: mesaId },
                        function(res) {
                            if (res.resultado) {
                                cargarMesasPorZona(zonaSeleccionada);
                            } else {
                                alert(res.mensaje);
                            }
                        }
                    );
                }
            });
        });
    </script>
}

