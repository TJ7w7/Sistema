@{
    ViewData["Title"] = "Gestión de Mesas";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .mesa-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 20px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
        min-height: 400px;
    }

    .mesa-card {
        background: white;
        border: 3px solid #dee2e6;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: relative;
        height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

        .mesa-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .mesa-card.disponible {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
        }

        .mesa-card.ocupada {
            border-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da 0%, #ffffff 100%);
        }

        .mesa-card.reservada {
            border-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
        }

        .mesa-card.eliminada {
            border-color: #6c757d;
            background: linear-gradient(135deg, #e2e3e5 0%, #ffffff 100%);
            opacity: 0.6;
        }

    .mesa-numero {
        font-size: 28px;
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
    }

    .mesa-estado {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .mesa-card.disponible .mesa-estado {
        color: #28a745;
    }

    .mesa-card.ocupada .mesa-estado {
        color: #dc3545;
    }

    .mesa-card.reservada .mesa-estado {
        color: #ffc107;
    }

    .mesa-card.eliminada .mesa-estado {
        color: #6c757d;
    }

    .btn-acciones {
        position: absolute;
        top: 5px;
        right: 5px;
        display: none;
    }

    .mesa-card:hover .btn-acciones {
        display: block;
    }

    .filtros-container {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .contador-mesas {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .contador-item {
        padding: 15px 25px;
        border-radius: 8px;
        text-align: center;
        flex: 1;
        min-width: 150px;
    }

        .contador-item.disponible {
            background: #d4edda;
            border: 2px solid #28a745;
        }

        .contador-item.ocupada {
            background: #f8d7da;
            border: 2px solid #dc3545;
        }

        .contador-item.reservada {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }

    .contador-numero {
        font-size: 32px;
        font-weight: bold;
        display: block;
    }

    .contador-label {
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
    }
</style>

<h2 class="mb-3">Gestión de Mesas</h2>

<!-- Contadores -->
<div class="contador-mesas">
    <div class="contador-item disponible">
        <span class="contador-numero" id="countDisponible">0</span>
        <span class="contador-label">Disponibles</span>
    </div>
    <div class="contador-item ocupada">
        <span class="contador-numero" id="countOcupada">0</span>
        <span class="contador-label">Ocupadas</span>
    </div>
    <div class="contador-item reservada">
        <span class="contador-numero" id="countReservada">0</span>
        <span class="contador-label">Reservadas</span>
    </div>
</div>

<!-- Filtros y acciones -->
<div class="filtros-container">
    <button type="button" class="btn btn-primary" id="btnAgregar">
        <i class="bi bi-plus-circle"></i> Agregar Mesa
    </button>

    <select class="form-select" id="filtroEstado" style="width: 200px;">
        <option value="">Todos los estados</option>
        <option value="Disponible">Disponible</option>
        <option value="Ocupada">Ocupada</option>
        <option value="Reservada">Reservada</option>
        <option value="Eliminada">Eliminada</option>
    </select>

    <button type="button" class="btn btn-secondary" id="btnMostrarEliminadas">
        <i class="bi bi-eye"></i> Mostrar Eliminadas
    </button>
</div>

<!-- Grid de Mesas -->
<div class="mesa-grid" id="mesasContainer">
    <!-- Las mesas se cargarán aquí dinámicamente -->
</div>

@await Html.PartialAsync("_ModalMesa")

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <script>
        $(document).ready(function () {
            let mostrarEliminadas = false;

            // ========================================
            // CARGAR MESAS
            // ========================================
            function cargarMesas() {
                let url = mostrarEliminadas
                    ? '@Url.Action("ObtenerMesasTodo", "MantenedorMesa")'
                    : '@Url.Action("ObtenerMesas", "MantenedorMesa")';

                $.ajax({
                    url: url,
                    type: "GET",
                    success: function (res) {
                        if (res.data) {
                            renderizarMesas(res.data);
                            actualizarContadores(res.data);
                        }
                    },
                    error: function () {
                        alert("Error al cargar las mesas.");
                    }
                });
            }

            // ========================================
            // RENDERIZAR MESAS
            // ========================================
            function renderizarMesas(mesas) {
                let container = $("#mesasContainer");
                container.empty();

                let filtroEstado = $("#filtroEstado").val();
                let mesasFiltradas = mesas;

                if (filtroEstado) {
                    mesasFiltradas = mesas.filter(m => m.estado === filtroEstado);
                }

                if (mesasFiltradas.length === 0) {
                    container.html('<p class="text-center mt-4">No hay mesas para mostrar</p>');
                    return;
                }

                mesasFiltradas.forEach(function (mesa) {
                    let estadoClass = mesa.estado.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

                    let card = `
                        <div class="mesa-card ${estadoClass}" data-id="${mesa.mesaId}">
                            <div class="btn-acciones">
                                <button class="btn btn-sm btn-warning btn-editar"
                                        data-id="${mesa.mesaId}"
                                        data-nromesa="${mesa.nroMesa}"
                                        data-estado="${mesa.estado}"
                                        title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </div>
                            <div class="mesa-numero">${mesa.nroMesa}</div>
                            <div class="mesa-estado">${mesa.estado}</div>
                        </div>
                    `;
                    container.append(card);
                });
            }

            // ========================================
            // ACTUALIZAR CONTADORES
            // ========================================
            function actualizarContadores(mesas) {
                let disponibles = mesas.filter(m => m.estado === "Disponible").length;
                let ocupadas = mesas.filter(m => m.estado === "Ocupada").length;
                let reservadas = mesas.filter(m => m.estado === "Reservada").length;

                $("#countDisponible").text(disponibles);
                $("#countOcupada").text(ocupadas);
                $("#countReservada").text(reservadas);
            }

            // ========================================
            // TOGGLE MESAS ELIMINADAS
            // ========================================
            $("#btnMostrarEliminadas").click(function () {
                mostrarEliminadas = !mostrarEliminadas;
                if (mostrarEliminadas) {
                    $(this).html('<i class="bi bi-eye-slash"></i> Ocultar Eliminadas');
                    $(this).removeClass('btn-secondary').addClass('btn-info');
                } else {
                    $(this).html('<i class="bi bi-eye"></i> Mostrar Eliminadas');
                    $(this).removeClass('btn-info').addClass('btn-secondary');
                }
                cargarMesas();
            });

            // ========================================
            // FILTRAR POR ESTADO
            // ========================================
            $("#filtroEstado").change(function () {
                cargarMesas();
            });

            // ========================================
            // ABRIR MODAL PARA AGREGAR MESA
            // ========================================
            $("#btnAgregar").click(function () {
                $("#modalMesaLabel").text("Agregar Mesa");
                $("#formMesa")[0].reset();
                $("#mesaId").val("0");
                $("#estado").val("Disponible");
                $("#modalMesa").modal("show");
            });

            // ========================================
            // ABRIR MODAL PARA EDITAR MESA
            // ========================================
            $(document).on("click", ".btn-editar", function (e) {
                e.stopPropagation();

                let id = $(this).data("id");
                let nroMesa = $(this).data("nromesa");
                let estado = $(this).data("estado");

                $("#modalMesaLabel").text("Editar Mesa");
                $("#mesaId").val(id);
                $("#nroMesa").val(nroMesa);
                $("#estado").val(estado);
                $("#modalMesa").modal("show");
            });

            // ========================================
            // ELIMINAR MESA AL HACER CLIC EN LA TARJETA
            // ========================================
            $(document).on("click", ".mesa-card", function (e) {
                if ($(e.target).closest('.btn-editar').length) {
                    return;
                }

                let id = $(this).data("id");
                let nroMesa = $(this).find(".mesa-numero").text();
                let estado = $(this).find(".mesa-estado").text();

                if (estado === "ELIMINADA") {
                    alert("Esta mesa ya está eliminada.");
                    return;
                }

                if (confirm(`¿Está seguro de eliminar la Mesa ${nroMesa}?`)) {
                    $.ajax({
                        url: '@Url.Action("EliminarMesa", "MantenedorMesa")',
                        type: "POST",
                        data: { mesaId: id },
                        success: function (res) {
                            if (res.resultado) {
                                alert(res.mensaje);
                                cargarMesas();
                            } else {
                                alert("Error: " + res.mensaje);
                            }
                        },
                        error: function () {
                            alert("Error al eliminar la mesa.");
                        }
                    });
                }
            });

            // ========================================
            // GUARDAR / EDITAR MESA
            // ========================================
            $("#formMesa").submit(function (e) {
                e.preventDefault();

                let datos = {
                    mesaId: parseInt($("#mesaId").val()) || 0,
                    nroMesa: parseInt($("#nroMesa").val()),
                    estado: $("#estado").val()
                };

                if (!datos.nroMesa || datos.nroMesa <= 0) {
                    alert("Por favor, ingrese un número de mesa válido.");
                    return;
                }

                $.ajax({
                    url: '@Url.Action("GuardarMesa", "MantenedorMesa")',
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(datos),
                    success: function (res) {
                        if (res.resultado) {
                            alert(res.mensaje);
                            $("#modalMesa").modal("hide");
                            cargarMesas();
                        } else {
                            alert("Error: " + res.mensaje);
                        }
                    },
                    error: function (xhr) {
                        let errorMsg = "Error al guardar la mesa.";
                        if (xhr.responseJSON && xhr.responseJSON.mensaje) {
                            errorMsg = xhr.responseJSON.mensaje;
                        }
                        alert(errorMsg);
                    }
                });
            });

            // Cargar mesas al inicio
            cargarMesas();
        });
    </script>
}