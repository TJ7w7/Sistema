@{
    ViewData["Title"] = "Mozo";
    Layout = "~/Views/Shared/_LayoutMozo.cshtml";
}

<div class="contenedor-pedidos">
    <!-- Encabezado -->
    <div class="encabezado">
        <span class="nombre-mesero">@ViewBag.NombreMesero</span>
        <div class="acciones-superior">
            <button class="btn-accion" onclick="volverAtras()">
                <i class="bi bi-arrow-left-short"></i>
            </button>
            <button class="btn-accion" onclick="agregarNuevo()">
                <i class="bi bi-plus-lg"></i>
            </button>
        </div>
    </div>

    <!-- Título -->
    <div class="titulo-seccion">Mesas</div>

    <!-- Botones de acción -->
    <div class="botones-acciones">
        <button class="btn-circular" onclick="buscarMesa()">
            <i class="bi bi-search"></i>
        </button>
        <button class="btn-circular" onclick="nuevoPedido()">
            <i class="bi bi-plus"></i>
        </button>
        <button class="btn-circular" onclick="refrescarMesas()">
            <i class="bi bi-arrow-clockwise"></i>
        </button>
        <button class="btn-circular" onclick="verHistorial()">
            <i class="bi bi-journal-text"></i>
        </button>
    </div>

    <!-- Contenedor de mesas (se llenará dinámicamente) -->
    <div class="grid-pedidos" id="contenedorMesas">
        <!-- Las mesas se cargarán aquí -->
        <div class="loading-container">
            <p>Cargando mesas...</p>
        </div>
    </div>
</div>

<!-- Modal Opciones Mesa (agregar antes de </div> contenedor-pedidos) -->
@* <div class="modal-overlay" id="modalOpcionesMesa">
    <div class="modal-opciones">
        <div class="modal-header-opciones">
            <h3>Mesa <span id="modalMesaNumero"></span></h3>
            <button class="btn-cerrar-modal-opciones" onclick="cerrarModalOpciones()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body-opciones">
            <button class="btn-opcion-mesa" onclick="verEditarPedido()">
                <i class="bi bi-pencil-square"></i>
                <span>Ver/Editar Pedido</span>
            </button>
            <button class="btn-opcion-mesa" onclick="agregarMasProductos()">
                <i class="bi bi-plus-circle"></i>
                <span>Agregar más productos</span>
            </button>
        </div>
    </div>
</div> *@

<!-- Modal Opciones Mesa -->
<div class="modal-overlay" id="modalOpcionesMesa" style="display: none;">
    <div class="modal-opciones">
        <div class="modal-header-opciones">
            <h3>Mesa <span id="modalMesaNumero"></span></h3>
            <button class="btn-cerrar-modal-opciones" onclick="cerrarModalOpciones()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body-opciones">
            <button class="btn-opcion-mesa" onclick="agregarEditarPedido()">
                <i class="bi bi-plus-circle"></i>
                <span>Agregar/Editar Pedido</span>
            </button>
            <button class="btn-opcion-mesa btn-ver-estado" onclick="verEstadoPedido()">
                <i class="bi bi-eye"></i>
                <span>Ver Estado y Entregar</span>
            </button>
        </div>
    </div>
</div>

<link rel="stylesheet" href="~/css/mozo.css" />

<script>
    console.log('Script cargado');

    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM cargado, iniciando carga de mesas...');
        cargarMesas();
    });

    function cargarMesas() {
        const url = '@Url.Action("ObtenerMesasActivas", "Mozo")';

        fetch(url)
            .then(response => response.json())
            .then(result => {
                console.log('Resultado:', result);
                if (result.success) {
                    console.log('Mesas recibidas:', result.data.length);
                    mostrarMesas(result.data);
                } else {
                    mostrarError(result.mensaje || 'Error desconocido');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarError('Error al cargar las mesas');
            });
    }

    function mostrarMesas(mesas) {
        const contenedor = document.getElementById('contenedorMesas');

        if (!mesas || mesas.length === 0) {
            contenedor.innerHTML = '<div class="sin-datos"><p>No hay mesas registradas</p></div>';
            return;
        }

        let html = '';
        mesas.forEach(mesa => {
            const estadoClass = obtenerClaseEstado(mesa.estado);
            const estadoTexto = obtenerTextoEstado(mesa.estado);

            html += `
                <div class="pedido ${estadoClass}" onclick="seleccionarMesa(${mesa.mesaId}, ${mesa.nroMesa})">
                    <p><strong>Mesa ${mesa.nroMesa}</strong></p>
                    <p class="estado-mesa">${estadoTexto}</p>
                </div>
            `;
        });

        contenedor.innerHTML = html;
    }

    function obtenerClaseEstado(estado) {
        if (!estado) return 'mesa-disponible';

        switch(estado.toLowerCase().trim()) {
            case 'disponible':
                return 'mesa-disponible';
            case 'ocupada':
            case 'ocupado':
                return 'mesa-ocupada';
            default:
                return 'mesa-disponible';
        }
    }

    function obtenerTextoEstado(estado) {
        if (!estado) return 'Disponible';
        return estado.charAt(0).toUpperCase() + estado.slice(1).toLowerCase();
    }

    function refrescarMesas() {
        cargarMesas();
    }

    function mostrarError(mensaje) {
        const contenedor = document.getElementById('contenedorMesas');
        contenedor.innerHTML = `
            <div class="error-container">
                <p class="error-mensaje">${mensaje}</p>
                <button class="btn-reintentar" onclick="cargarMesas()">Reintentar</button>
            </div>
        `;
    }

        // Modificar la función seleccionarMesa
    function seleccionarMesa(mesaId, nroMesa) {
        console.log('Mesa seleccionada:', mesaId, nroMesa);

        // Verificar si la mesa está ocupada (tiene pedido activo)
        fetch(`@Url.Action("ObtenerPedidoPorMesa", "Pedido")?mesaId=${mesaId}`)
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Mesa ocupada - mostrar opciones
                    mostrarOpcionesMesa(mesaId, nroMesa, result.pedido.pedidoId);
                } else {
                    // Mesa libre - crear nuevo pedido
                    window.location.href = `@Url.Action("CrearPedido", "Pedido")?mesaId=${mesaId}&nroMesa=${nroMesa}`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // En caso de error, asumir que está libre
                window.location.href = `@Url.Action("CrearPedido", "Pedido")?mesaId=${mesaId}&nroMesa=${nroMesa}`;
            });
    }


    // Variable global para almacenar datos del modal
    let mesaSeleccionada = { mesaId: 0, nroMesa: 0, pedidoId: 0 };

    //Mostrar modal de opciones
    function mostrarOpcionesMesa(mesaId, nroMesa, pedidoId) {
        mesaSeleccionada = { mesaId, nroMesa, pedidoId };
        document.getElementById('modalMesaNumero').textContent = nroMesa;
        document.getElementById('modalOpcionesMesa').classList.add('show');
    }


    // Cerrar modal de opciones
    function cerrarModalOpciones() {
        document.getElementById('modalOpcionesMesa').classList.remove('show');
    }

        // Agregar/Editar pedido
    function agregarEditarPedido() {
        window.location.href = `@Url.Action("EditarPedido", "Pedido")?mesaId=${mesaSeleccionada.mesaId}&nroMesa=${mesaSeleccionada.nroMesa}&pedidoId=${mesaSeleccionada.pedidoId}`;
    }

    // Ver estado del pedido
    function verEstadoPedido() {
        window.location.href = `@Url.Action("VerEstado", "Pedido")?mesaId=${mesaSeleccionada.mesaId}&nroMesa=${mesaSeleccionada.nroMesa}&pedidoId=${mesaSeleccionada.pedidoId}`;
    }

    // Eliminar estas funciones ya no necesarias
    // function verEditarPedido() { ... }
    // function agregarMasProductos() { ... }

    // // Ver/Editar pedido
    // function verEditarPedido() {
    //     window.location.href = `@Url.Action("EditarPedido", "Pedido")?mesaId=${mesaSeleccionada.mesaId}&nroMesa=${mesaSeleccionada.nroMesa}&pedidoId=${mesaSeleccionada.pedidoId}`;
    // }

    // // Agregar más productos (mismo que editar)
    // function agregarMasProductos() {
    //     verEditarPedido();
    // }

    // Funciones de botones
    function volverAtras() {
        window.history.back();
    }

    function agregarNuevo() {
        alert('Agregar nuevo');
    }

    function buscarMesa() {
        alert('Buscar mesa');
    }

    function nuevoPedido() {
        alert('Nuevo pedido');
    }

    function verHistorial() {
        alert('Ver historial');
    }
</script>