@{
    ViewData["Title"] = "Gestión de Estaciones";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2 class="mb-3">Gestión de Estaciones</h2>

<!-- Botón Agregar -->
<button type="button" class="btn btn-primary mb-3" id="btnAgregar">
    Agregar Estación
</button>

<!-- Tabla -->
<table id="tablaEstaciones" class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>

@await Html.PartialAsync("_ModalEstacion")

@section Scripts {
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />

    <script>
                $(document).ready(function () {
            var tabla = $('#tablaEstaciones').DataTable({
                ajax: {
                    url: '@Url.Action("ObtenerEstaciones", "MantenedorEstacion")',
                    dataSrc: "data"
                },
                columns: [
                    { data: "estacionId" },
                    { data: "nombre" },
                    {
                        data: "estado",
                        render: function (data) {
                            return data ? "Activo ✅" : "Inactivo ❌";
                        }
                    },
                    {
                        data: "estacionId",
                        render: function (data, type, row) {
                            return `
                                <button class="btn btn-sm btn-warning btn-editar"
                                        data-id="${row.estacionId}"
                                        data-nombre="${row.nombre}"
                                        data-estado="${row.estado}">
                                    Editar
                                </button>
                            `;
                        }
                    }
                ],
                language: {
                    url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
                }
            });

            // Abrir modal para agregar
            $("#btnAgregar").click(function () {
                $("#modalEstacionLabel").text("Agregar Estación");
                $("#formEstacion")[0].reset();
                $("#estacionId").val(""); // Vacío para nuevo
                $("#estado").val("true"); // ✅ Por defecto activo
                $("#modalEstacion").modal("show");
            });

            // Abrir modal para editar
            $(document).on("click", ".btn-editar", function () {
                var id = $(this).data("id");
                var nombre = $(this).data("nombre");
                var estado = $(this).data("estado");

                $("#modalEstacionLabel").text("Editar Estación");
                $("#estacionId").val(id);
                $("#nombre").val(nombre);
                $("#estado").val(estado.toString()); // ✅ Convertir boolean a string
                $("#modalEstacion").modal("show");
            });

            // Guardar / Editar estación - CORREGIDO
            $("#formEstacion").submit(function (e) {
                e.preventDefault();

                // ✅ Para SELECT, necesitas convertir el string a boolean
                var datos = {
                    estacionId: parseInt($("#estacionId").val()) || 0,  // ✅ Asegurar número
                    nombre: $("#nombre").val().trim(),                  // ✅ Trim para limpiar
                    estado: $("#estado").val() === "true"               // ✅ Convertir string a boolean
                };

                console.log("Datos a enviar:", datos); // ✅ Para debug

                // ✅ Validación
                if (!datos.nombre) {
                    alert("El nombre de la estación es requerido");
                    return;
                }

                $.ajax({
                    url: '@Url.Action("GuardarEstacion", "MantenedorEstacion")',
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(datos),
                    success: function (res) {
                        console.log("Respuesta:", res);
                        alert(res.mensaje);
                        if(res.resultado === 1 || res.resultado === true) {
                            $("#modalEstacion").modal("hide");
                            tabla.ajax.reload();
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error:", error);
                        alert("Ocurrió un error al guardar la estación.");
                    }
                });
            });
        });
    </script>
}