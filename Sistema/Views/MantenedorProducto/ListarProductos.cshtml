@{
    ViewData["Title"] = "Gestión de Productos";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2 class="mb-3">Gestión de Productos</h2>

<!-- Botón Agregar -->
<button type="button" class="btn btn-primary mb-3" id="btnAgregar">
    <i class="bi bi-plus-circle"></i> Agregar Producto
</button>

<!-- Tabla -->
<table id="tablaProductos" class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Descripción</th>
            <th>Precios</th>
            <th>Categoría</th>
            <th>Imagen</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

@await Html.PartialAsync("_ModalProducto")
@await Html.PartialAsync("_ModalReceta")

@section Scripts {
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />

    <script>
        $(document).ready(function () {
            // ========================================
            // INICIALIZACIÓN DEL DATATABLE
            // ========================================
            var tabla = $('#tablaProductos').DataTable({
                ajax: {
                    url: '@Url.Action("ObtenerProductos", "MantenedorProducto")',
                    dataSrc: "data"
                },
                columns: [
                    { data: "productoId" },
                    { data: "nombre" },
                    {
                        data: "descripcion",
                        render: function (data) {
                            if (!data) return "<span class='text-muted'>-</span>";
                            return data.length > 50 ? data.substring(0, 50) + "..." : data;
                        }
                    },
                    {
                        data: null,
                        render: function (data, type, row) {
                            if (!row.variantes || row.variantes.length === 0) {
                                return "<span class='text-muted'>Sin precios</span>";
                            }

                            if (row.variantes.length === 1) {
                                return `<strong>S/ ${row.variantes[0].precio.toFixed(2)}</strong><br><small class="text-muted">${row.variantes[0].tamaño}</small>`;
                            }

                            var precios = row.variantes.map(v =>
                                `<div><strong>S/ ${v.precio.toFixed(2)}</strong> <small class="text-muted">(${v.tamaño})</small></div>`
                            ).join('');

                            return precios;
                        }
                    },
                    { data: "nombreCategoria" },
                    {
                        data: "imagen",
                        render: function (data) {
                            if (data) {
                                return `<img src="@Url.Action("Producto", "Imagen")?nombre=${data}" class="rounded" style="width: 50px; height: 50px; object-fit: cover;">`;
                            }
                            return "<span class='text-muted'>Sin imagen</span>";
                        }
                    },
                    {
                        data: "estado",
                        render: function (data) {
                            return data ?
                                '<span class="badge bg-success">Activo</span>' :
                                '<span class="badge bg-danger">Inactivo</span>';
                        }
                    },
                    {
                        data: "productoId",
                        render: function (data, type, row) {
                            return `
                                <button class="btn btn-sm btn-warning btn-editar"
                                        data-producto='${JSON.stringify(row)}'>
                                    <i class="bi bi-pencil"></i> Editar
                                </button>
                                <button class="btn btn-sm btn-success btn-receta"
                                        data-id="${row.productoId}"
                                        data-nombre="${row.nombre}">
                                    <i class="bi bi-clipboard-check"></i> Receta
                                </button>
                            `;
                        }
                    }
                ],
                language: {
                    url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
                },
                order: [[0, 'desc']]
            });

            // ========================================
            // CARGAR CATEGORÍAS Y ESTACIONES
            // ========================================
            function cargarCategorias() {
                $.ajax({
                    url: '@Url.Action("ObtenerCategorias", "MantenedorProducto")',
                    type: "GET",
                    success: function (res) {
                        var $select = $("#categoriaId");
                        $select.empty();
                        $select.append('<option value="">Seleccione categoría</option>');
                        $.each(res, function (i, cat) {
                            $select.append(`<option value="${cat.categoriaId}">${cat.nombre}</option>`);
                        });
                    },
                    error: function () {
                        console.error("Error al cargar categorías");
                    }
                });
            }

            function cargarEstaciones() {
                $.ajax({
                    url: '@Url.Action("ObtenerEstaciones", "MantenedorProducto")',
                    type: "GET",
                    success: function (res) {
                        var $select = $("#estacionId");
                        $select.empty();
                        $select.append('<option value="">Ninguna</option>');
                        $.each(res, function (i, est) {
                            $select.append(`<option value="${est.estacionId}">${est.nombre}</option>`);
                        });
                    },
                    error: function () {
                        console.error("Error al cargar estaciones");
                    }
                });
            }

            // ========================================
            // GESTIÓN DE VARIANTES
            // ========================================
            $("#btnAgregarVariante").click(function() {
                var html = `
                    <div class="row mb-2 variante-row">
                        <div class="col-md-5">
                            <select class="form-select tamaño-select" required>
                                <option value="">Seleccione tamaño</option>
                                <option value="Personal">Personal</option>
                                <option value="Mediano">Mediano</option>
                                <option value="Fuente">Fuente</option>
                                <option value="Familiar">Familiar</option>
                                <option value="Individual">Individual</option>
                                <option value="Grande">Grande</option>
                            </select>
                        </div>
                        <div class="col-md-5">
                            <input type="number" step="0.01" class="form-control precio-input" placeholder="Precio" required min="0">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-danger btn-sm btn-eliminar-variante">
                                <i class="bi bi-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                `;
                $("#variantes").append(html);
            });

            $(document).on("click", ".btn-eliminar-variante", function() {
                if ($(".variante-row").length > 1) {
                    $(this).closest(".variante-row").remove();
                } else {
                    alert("Debe tener al menos un precio/tamaño");
                }
            });

            // ========================================
            // VISTA PREVIA DE IMAGEN
            // ========================================
            $("#imagen").change(function () {
                var file = this.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        alert("La imagen no debe superar 5MB");
                        $(this).val("");
                        $("#vistaPrevia").html("");
                        return;
                    }

                    var extensionesPermitidas = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp'];
                    if (!extensionesPermitidas.includes(file.type)) {
                        alert("Solo se permiten imágenes JPG, PNG, GIF o BMP");
                        $(this).val("");
                        $("#vistaPrevia").html("");
                        return;
                    }

                    var reader = new FileReader();
                    reader.onload = function (e) {
                        $("#vistaPrevia").html(`
                            <div class="text-center">
                                <img src="${e.target.result}" class="img-thumbnail" style="max-height: 200px;">
                                <p class="text-muted mt-2">Vista previa</p>
                            </div>
                        `);
                    }
                    reader.readAsDataURL(file);
                }
            });

            // ========================================
            // ABRIR MODAL PARA AGREGAR
            // ========================================
            $("#btnAgregar").click(function () {
                $("#modalProductoLabel").text("Agregar Producto");
                $("#formProducto")[0].reset();
                $("#productoId").val("");
                $("#imagenActual").val("");
                $("#estado").val("true");
                $("#vistaPrevia").html("");

                // Resetear variantes - dejar solo una fila vacía
                $("#variantes").html(`
                    <div class="row mb-2 variante-row">
                        <div class="col-md-5">
                            <select class="form-select tamaño-select" required>
                                <option value="">Seleccione tamaño</option>
                                <option value="Personal">Personal</option>
                                <option value="Mediano">Mediano</option>
                                <option value="Fuente">Fuente</option>
                                <option value="Familiar">Familiar</option>
                                <option value="Individual">Individual</option>
                                <option value="Grande">Grande</option>
                            </select>
                        </div>
                        <div class="col-md-5">
                            <input type="number" step="0.01" class="form-control precio-input" placeholder="Precio" required min="0">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-danger btn-sm btn-eliminar-variante">
                                <i class="bi bi-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                `);

                cargarCategorias();
                cargarEstaciones();
                $("#modalProducto").modal("show");
            });

            // ========================================
            // ABRIR MODAL PARA EDITAR
            // ========================================
            $(document).on("click", ".btn-editar", function () {
                var producto = JSON.parse($(this).attr('data-producto'));

                $("#modalProductoLabel").text("Editar Producto");
                $("#productoId").val(producto.productoId);
                $("#nombre").val(producto.nombre);
                $("#descripcion").val(producto.descripcion || "");
                $("#imagenActual").val(producto.imagen);
                $("#estado").val(producto.estado.toString());
                $("#imagen").val("");

                cargarCategorias();
                cargarEstaciones();

                setTimeout(function() {
                    $("#categoriaId").val(producto.categoriaId);
                    if (producto.estacionId) {
                        $("#estacionId").val(producto.estacionId);
                    }
                }, 300);

                // Cargar variantes existentes
                $("#variantes").html("");
                if (producto.variantes && producto.variantes.length > 0) {
                    producto.variantes.forEach(function(v) {
                        var html = `
                            <div class="row mb-2 variante-row">
                                <div class="col-md-5">
                                    <select class="form-select tamaño-select" required>
                                        <option value="">Seleccione tamaño</option>
                                        <option value="Personal" ${v.tamaño === 'Personal' ? 'selected' : ''}>Personal</option>
                                        <option value="Mediano" ${v.tamaño === 'Mediano' ? 'selected' : ''}>Mediano</option>
                                        <option value="Fuente" ${v.tamaño === 'Fuente' ? 'selected' : ''}>Fuente</option>
                                        <option value="Familiar" ${v.tamaño === 'Familiar' ? 'selected' : ''}>Familiar</option>
                                        <option value="Individual" ${v.tamaño === 'Individual' ? 'selected' : ''}>Individual</option>
                                        <option value="Grande" ${v.tamaño === 'Grande' ? 'selected' : ''}>Grande</option>
                                    </select>
                                </div>
                                <div class="col-md-5">
                                    <input type="number" step="0.01" class="form-control precio-input" value="${v.precio}" required min="0">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-danger btn-sm btn-eliminar-variante">
                                        <i class="bi bi-trash"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                        `;
                        $("#variantes").append(html);
                    });
                }

                if (producto.imagen) {
                    $("#vistaPrevia").html(`
                        <div class="text-center">
                            <img src="@Url.Action("Producto", "Imagen")?nombre=${producto.imagen}" class="img-thumbnail" style="max-height: 200px;">
                            <p class="text-muted mt-2">Imagen actual</p>
                        </div>
                    `);
                } else {
                    $("#vistaPrevia").html("");
                }

                $("#modalProducto").modal("show");
            });

            // ========================================
            // FUNCIÓN PARA SUBIR IMAGEN
            // ========================================
            async function subirImagen() {
                var archivo = $("#imagen")[0].files[0];
                if (!archivo) return null;

                var formData = new FormData();
                formData.append("imagen", archivo);

                try {
                    const response = await $.ajax({
                        url: '@Url.Action("SubirImagen", "MantenedorProducto")',
                        type: "POST",
                        data: formData,
                        processData: false,
                        contentType: false
                    });

                    if (response.exito) {
                        return response.nombreArchivo;
                    } else {
                        alert(response.mensaje);
                        return null;
                    }
                } catch (error) {
                    alert("Error al subir la imagen");
                    return null;
                }
            }

            // ========================================
            // GUARDAR PRODUCTO
            // ========================================
            $("#formProducto").submit(async function (e) {
                e.preventDefault();

                var btnSubmit = $(this).find('button[type="submit"]');
                btnSubmit.prop("disabled", true).html('<span class="spinner-border spinner-border-sm"></span> Guardando...');

                try {
                    // Recopilar variantes
                    var variantes = [];
                    var variantesValidas = true;

                    $(".variante-row").each(function() {
                        var tamaño = $(this).find(".tamaño-select").val();
                        var precio = $(this).find(".precio-input").val();

                        if (tamaño && precio && parseFloat(precio) > 0) {
                            variantes.push({
                                tamaño: tamaño,
                                precio: parseFloat(precio)
                            });
                        } else if (!tamaño || !precio) {
                            variantesValidas = false;
                        }
                    });

                    if (!variantesValidas || variantes.length === 0) {
                        alert("Debe agregar al menos un precio/tamaño válido");
                        btnSubmit.prop("disabled", false).html('Guardar');
                        return;
                    }

                    // Subir imagen si hay una nueva
                    var nombreImagen = $("#imagenActual").val();
                    if ($("#imagen")[0].files.length > 0) {
                        nombreImagen = await subirImagen();
                        if (!nombreImagen) {
                            btnSubmit.prop("disabled", false).html('Guardar');
                            return;
                        }
                    }

                    var datos = {
                        productoId: parseInt($("#productoId").val()) || 0,
                        nombre: $("#nombre").val().trim(),
                        descripcion: $("#descripcion").val().trim() || null,
                        categoriaId: parseInt($("#categoriaId").val()),
                        estacionId: $("#estacionId").val() ? parseInt($("#estacionId").val()) : null,
                        imagen: nombreImagen,
                        estado: $("#estado").val() === "true",
                        variantes: variantes
                    };

                    if (!datos.nombre || !datos.categoriaId) {
                        alert("Por favor, complete todos los campos requeridos.");
                        btnSubmit.prop("disabled", false).html('Guardar');
                        return;
                    }

                    $.ajax({
                        url: '@Url.Action("GuardarProducto", "MantenedorProducto")',
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(datos),
                        success: function (res) {
                            alert(res.mensaje);
                            if (res.exito) {
                                $("#modalProducto").modal("hide");
                                tabla.ajax.reload();
                            }
                        },
                        error: function () {
                            alert("Error al guardar el producto");
                        },
                        complete: function () {
                            btnSubmit.prop("disabled", false).html('Guardar');
                        }
                    });
                } catch (error) {
                    alert("Error inesperado");
                    btnSubmit.prop("disabled", false).html('Guardar');
                }
            });
            // ========================================
            // GESTIÓN DE RECETA
            // ========================================
            var ingredientesReceta = [];

            // Abrir modal de receta
            $(document).on("click", ".btn-receta", function () {
                var productoId = $(this).data("id");
                var nombreProducto = $(this).data("nombre");

                $("#nombreProductoReceta").text(nombreProducto);
                $("#productoIdReceta").val(productoId);

                cargarReceta(productoId);
                cargarInsumosParaReceta();

                $("#modalReceta").modal("show");
            });

            // Cargar receta actual
            function cargarReceta(productoId) {
                $.ajax({
                    url: '@Url.Action("ObtenerReceta", "MantenedorProducto")',
                    type: "GET",
                    data: { productoId: productoId },
                    success: function (receta) {
                        ingredientesReceta = receta;
                        mostrarIngredientes();
                    },
                    error: function () {
                        ingredientesReceta = [];
                        mostrarIngredientes();
                    }
                });
            }

            // Mostrar ingredientes
            function mostrarIngredientes() {
                var container = $("#listaIngredientes");
                container.html("");

                if (ingredientesReceta.length === 0) {
                    container.html('<p class="text-muted">No hay ingredientes en la receta</p>');
                    return;
                }

                ingredientesReceta.forEach(function (ing, index) {
                    var card = `
                        <div class="card mb-2">
                            <div class="card-body py-2">
                                <div class="row align-items-center">
                                    <div class="col-md-5">
                                        <strong>${ing.nombreInsumo}</strong>
                                    </div>
                                    <div class="col-md-5">
                                        <div class="input-group input-group-sm">
                                            <input type="number" step="0.01" class="form-control cantidad-ingrediente"
                                                   value="${ing.cantidad}"
                                                   data-index="${index}"
                                                   min="0.01">
                                            <span class="input-group-text">${ing.unidadMedida}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <button class="btn btn-sm btn-danger btn-eliminar-ingrediente"
                                                data-index="${index}">
                                            <i class="bi bi-trash"></i> Eliminar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.append(card);
                });
            }

            // Cargar insumos disponibles
            function cargarInsumosParaReceta() {
                $.ajax({
                    url: '@Url.Action("ObtenerInsumosActivos", "MantenedorProducto")',
                    type: "GET",
                    success: function (insumos) {
                        var $select = $("#insumoIdReceta");
                        $select.empty();
                        $select.append('<option value="">Seleccione un insumo...</option>');

                        insumos.forEach(function (i) {
                            $select.append(`<option value="${i.insumoId}" data-unidad="${i.unidadMedida}">${i.nombre}</option>`);
                        });
                    }
                });
            }

            // Actualizar unidad al seleccionar insumo
            $("#insumoIdReceta").change(function () {
                var selectedOption = $(this).find("option:selected");
                var unidad = selectedOption.data("unidad") || "-";
                $("#unidadMedidaReceta").text(unidad);
            });

            // Agregar ingrediente
            $("#formAgregarIngrediente").submit(function (e) {
                e.preventDefault();

                var insumoId = parseInt($("#insumoIdReceta").val());
                var cantidad = parseFloat($("#cantidadReceta").val());
                var nombreInsumo = $("#insumoIdReceta option:selected").text();
                var unidadMedida = $("#unidadMedidaReceta").text();

                if (!insumoId || cantidad <= 0) {
                    alert("Complete todos los campos correctamente");
                    return;
                }

                var existe = ingredientesReceta.find(i => i.insumoId === insumoId);
                if (existe) {
                    alert("Este insumo ya está en la receta");
                    return;
                }

                ingredientesReceta.push({
                    insumoId: insumoId,
                    nombreInsumo: nombreInsumo,
                    unidadMedida: unidadMedida,
                    cantidad: cantidad
                });

                mostrarIngredientes();
                $("#formAgregarIngrediente")[0].reset();
                $("#unidadMedidaReceta").text("-");
            });

            // Actualizar cantidad
            $(document).on("change", ".cantidad-ingrediente", function () {
                var index = $(this).data("index");
                var nuevaCantidad = parseFloat($(this).val());

                if (nuevaCantidad > 0) {
                    ingredientesReceta[index].cantidad = nuevaCantidad;
                } else {
                    alert("La cantidad debe ser mayor a 0");
                    $(this).val(ingredientesReceta[index].cantidad);
                }
            });

            // Eliminar ingrediente
            $(document).on("click", ".btn-eliminar-ingrediente", function () {
                var index = $(this).data("index");

                if (confirm("¿Eliminar este ingrediente?")) {
                    ingredientesReceta.splice(index, 1);
                    mostrarIngredientes();
                }
            });

            // Guardar receta
            $("#btnGuardarReceta").click(function () {
                var productoId = parseInt($("#productoIdReceta").val());

                if (ingredientesReceta.length === 0) {
                    if (!confirm("La receta está vacía. ¿Guardar sin ingredientes?")) {
                        return;
                    }
                }

                var btn = $(this);
                btn.prop("disabled", true).html('<span class="spinner-border spinner-border-sm"></span> Guardando...');

                var datos = {
                    productoId: productoId,
                    ingredientes: ingredientesReceta.map(i => ({
                        insumoId: i.insumoId,
                        cantidad: i.cantidad
                    }))
                };

                $.ajax({
                    url: '@Url.Action("GuardarReceta", "MantenedorProducto")',
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(datos),
                    success: function (res) {
                        alert(res.mensaje);
                        if (res.exito) {
                            $("#modalReceta").modal("hide");
                            tabla.ajax.reload();
                        }
                    },
                    error: function () {
                        alert("Error al guardar la receta");
                    },
                    complete: function () {
                        btn.prop("disabled", false).html('<i class="bi bi-save"></i> Guardar Receta');
                    }
                });
            });

            // Limpiar al cerrar modal
            $("#modalReceta").on("hidden.bs.modal", function () {
                ingredientesReceta = [];
                $("#formAgregarIngrediente")[0].reset();
                $("#unidadMedidaReceta").text("-");
            });
        });
    </script>
}