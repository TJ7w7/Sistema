@{
    ViewData["Title"] = "Gestión de Categorías";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2 class="mb-3">Gestión de Categorías</h2>

<!-- Botón Agregar -->
<button type="button" class="btn btn-primary mb-3" id="btnAgregar">
    Agregar Categoría
</button>

<!-- Tabla -->
<table id="tablaCategorias" class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>

@await Html.PartialAsync("_ModalCategoria")

@section Scripts {
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />

    <script>
        $(document).ready(function () {
            var tabla = $('#tablaCategorias').DataTable({
                ajax: {
                    url: '@Url.Action("ObtenerCategorias", "MantenedorCategoria")',
                    dataSrc: "data"
                },
                columns: [
                    { data: "categoriaId" },
                    { data: "nombre" },
                    {
                        data: "estado",
                        render: function (data) {
                            return data ? "Activo ✅" : "Inactivo ❌";
                        }
                    },
                    {
                        data: "categoriaId",
                        render: function (data, type, row) {
                            return `
                                <button class="btn btn-sm btn-warning btn-editar"
                                        data-id="${row.categoriaId}"
                                        data-nombre="${row.nombre}"
                                        data-estado="${row.estado}">
                                    Editar
                                </button>
                            `;
                        }
                    }
                ],
                language: {
                    url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
                }
            });

            // Abrir modal para agregar
            $("#btnAgregar").click(function () {
                $("#modalCategoriaLabel").text("Agregar Categoría");
                $("#formCategoria")[0].reset();
                $("#categoriaId").val("");
                $("#estado").val("true");
                $("#modalCategoria").modal("show");
            });

            // Abrir modal para editar
            $(document).on("click", ".btn-editar", function () {
                var id = $(this).data("id");
                var nombre = $(this).data("nombre");
                var estado = $(this).data("estado");

                $("#modalCategoriaLabel").text("Editar Categoría");
                $("#categoriaId").val(id);
                $("#nombre").val(nombre);
                $("#estado").val(estado.toString());
                $("#modalCategoria").modal("show");
            });

            // Guardar / Editar categoría
            $("#formCategoria").submit(function (e) {
                e.preventDefault();

                var datos = {
                    categoriaId: parseInt($("#categoriaId").val()) || 0,
                    nombre: $("#nombre").val().trim(),
                    estado: $("#estado").val() === "true"
                };

                if (!datos.nombre) {
                    alert("El nombre de la categoría es requerido");
                    return;
                }

                $.ajax({
                    url: '@Url.Action("GuardarCategoria", "MantenedorCategoria")',
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(datos),
                    success: function (res) {
                        alert(res.mensaje);
                        if (res.resultado === 1 || res.resultado === true) {
                            $("#modalCategoria").modal("hide");
                            tabla.ajax.reload();
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error:", error);
                        alert("Ocurrió un error al guardar la categoría.");
                    }
                });
            });
        });
    </script>
}
