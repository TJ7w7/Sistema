@{
    ViewData["Title"] = "Gestión de Usuarios";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2 class="mb-3">Gestión de Usuarios</h2>

<!-- Botón Agregar -->
<button type="button" class="btn btn-primary mb-3" id="btnAgregar">
    Agregar Usuario
</button>

<!-- Tabla -->
<table id="tablaUsuarios" class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>ID</th>
            <th>Rol</th>
            <th>Nombre</th>
            <th>Apellido</th>
            <th>Usuario</th>
            <th>Estación</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

@await Html.PartialAsync("_ModalUsuario")

@section Scripts {
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />

    <script>
                $(document).ready(function () {
            // ========================================
            // INICIALIZACIÓN DEL DATATABLE
            // ========================================
            var tabla = $('#tablaUsuarios').DataTable({
                ajax: {
                    url: '@Url.Action("ObtenerUsuarios", "MantenedorUsuario")',
                    dataSrc: "data"
                },
                columns: [
                    { data: "usuarioId" },
                    { data: "rol" },
                    { data: "nombre" },
                    { data: "apellido" },
                    { data: "userName" },
                    {
                        data: "estacionId",
                        render: function (data) {
                            return data ? data : "—";
                        }
                    },
                    {
                        data: "estado",
                        render: function (data) {
                            return data ? "Activo ✅" : "Inactivo ❌";
                        }
                    },
                    {
                        data: "usuarioId",
                        render: function (data, type, row) {
                            return `
                                <button class="btn btn-sm btn-warning btn-editar"
                                        data-id="${row.usuarioId}"
                                        data-rol="${row.rol}"
                                        data-nombre="${row.nombre}"
                                        data-apellido="${row.apellido}"
                                        data-estacionid="${row.estacionId}"
                                        data-username="${row.userName}"
                                        data-pass="${row.pass}"
                                        data-estado="${row.estado}">
                                    Editar
                                </button>
                            `;
                        }
                    }
                ],
                language: {
                    url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
                }
            });

            // ========================================
            // FUNCIÓN PARA CARGAR ESTACIONES
            // ========================================
            function cargarEstaciones() {
                $.ajax({
                    url: '@Url.Action("ObtenerEstacionesActivas", "MantenedorUsuario")',
                    type: "GET",
                    success: function (res) {
                        var $select = $("#estacionId");
                        $select.empty();
                        $select.append('<option value="">Seleccione una estación</option>');
                        $.each(res, function (i, e) {
                            $select.append(`<option value="${e.estacionId}">${e.nombre}</option>`);
                        });
                    },
                    error: function () {
                        alert("Error al cargar las estaciones.");
                    }
                });
            }

            // ========================================
            // MOSTRAR/OCULTAR CONTRASEÑA
            // ========================================
            $("#btnMostrarNuevaPass").click(function () {
                var input = $("#nuevaPass");
                var icono = $("#iconoOjoNueva");

                if (input.attr("type") === "password") {
                    input.attr("type", "text");
                    icono.removeClass("bi-eye").addClass("bi-eye-slash");
                } else {
                    input.attr("type", "password");
                    icono.removeClass("bi-eye-slash").addClass("bi-eye");
                }
            });

            // ========================================
            // MOSTRAR/OCULTAR SECCIÓN DE ESTACIÓN SEGÚN ROL
            // ========================================
            $("#rol").change(function () {
                var rolSeleccionado = $(this).val();
                if (rolSeleccionado === "Cocinero") {
                    $("#seccionEstacion").show();
                    cargarEstaciones();
                    $("#estacionId").prop("required", true);
                } else {
                    $("#seccionEstacion").hide();
                    $("#estacionId").val("").prop("required", false);
                }
            });

            // ========================================
            // ABRIR MODAL PARA AGREGAR USUARIO
            // ========================================
            $("#btnAgregar").click(function () {
                $("#modalUsuarioLabel").text("Agregar Usuario");
                $("#formUsuario")[0].reset();
                $("#usuarioId").val("");
                $("#estado").val("true");
                $("#seccionEditar").hide();
                $("#seccionEstacion").hide();
                $("#estacionId").prop("required", false);
                $("#modalUsuario").modal("show");
            });

            // ========================================
            // ABRIR MODAL PARA EDITAR USUARIO
            // ========================================
            $(document).on("click", ".btn-editar", function () {
                var id = $(this).data("id");
                var rol = $(this).data("rol");
                var nombre = $(this).data("nombre");
                var apellido = $(this).data("apellido");
                var estacionId = $(this).data("estacionid");
                var estado = $(this).data("estado");
                var userName = $(this).data("username") || "";
                var pass = $(this).data("pass") || "";

                $("#modalUsuarioLabel").text("Editar Usuario");
                $("#usuarioId").val(id);
                $("#rol").val(rol);
                $("#nombre").val(nombre);
                $("#apellido").val(apellido);
                $("#estado").val(estado.toString());
                $("#userName").val(userName);
                $("#passActual").val(pass); // Guardar contraseña encriptada actual
                $("#nuevaPass").val("");
                $("#seccionEditar").show();

                // Restablecer icono de contraseña
                $("#nuevaPass").attr("type", "password");
                $("#iconoOjoNueva").removeClass("bi-eye-slash").addClass("bi-eye");

                // Mostrar sección de estación solo si es Cocinero
                if (rol === "Cocinero") {
                    $("#seccionEstacion").show();
                    $("#estacionId").prop("required", true);
                    cargarEstaciones();
                    setTimeout(function() {
                        $("#estacionId").val(estacionId);
                    }, 300);
                } else {
                    $("#seccionEstacion").hide();
                    $("#estacionId").prop("required", false);
                }

                $("#modalUsuario").modal("show");
            });

            // ========================================
            // GUARDAR / EDITAR USUARIO
            // ========================================
                    // Guardar / Editar usuario
        $("#formUsuario").submit(function (e) {
            e.preventDefault();

            var usuarioId = parseInt($("#usuarioId").val()) || 0;

            var datos = {
                usuarioId: usuarioId,
                rol: $("#rol").val().trim(),
                nombre: $("#nombre").val().trim(),
                apellido: $("#apellido").val().trim(),
                estacionId: $("#estacionId").val() ? parseInt($("#estacionId").val()) : null,
                estado: $("#estado").val() === "true"
            };

            // Si estamos editando, agregar userName y contraseña
            if (usuarioId > 0) {
                datos.userName = $("#userName").val().trim();

                var nuevaPass = $("#nuevaPass").val().trim();
                if (nuevaPass) {
                    datos.pass = nuevaPass;
                } else {
                    datos.pass = $("#passActual").val();
                }
            }

            // Validaciones
            if (!datos.nombre || !datos.apellido || !datos.rol) {
                alert("Por favor, complete todos los campos requeridos.");
                return;
            }

            if (datos.rol === "Cocinero" && !datos.estacionId) {
                alert("Debe seleccionar una estación para el rol Cocinero.");
                return;
            }

            // Enviar datos al servidor
            $.ajax({
                url: '@Url.Action("GuardarUsuario", "MantenedorUsuario")',
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(datos),
                success: function (res) {
                    if (res.resultado === 1 || res.resultado === true) {
                        // Si es un usuario nuevo, mostrar credenciales generadas
                        if (usuarioId === 0 && res.passwordTemporal && res.userName) {
                            alert(
                                "✅ " + res.mensaje + "\n\n" +
                                "📋 CREDENCIALES DE ACCESO:\n" +
                                "Usuario: " + res.userName + "\n" +
                                "Contraseña: " + res.passwordTemporal + "\n\n" +
                                "⚠️ IMPORTANTE: Guarde estas credenciales, no podrá verlas nuevamente."
                            );
                        } else {
                            alert(res.mensaje);
                        }

                        $("#modalUsuario").modal("hide");
                        tabla.ajax.reload();
                    } else {
                        alert("Error: " + res.mensaje);
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error:", error);
                    alert("Ocurrió un error al guardar el usuario.");
                }
            });
        });
        });
    </script>
}